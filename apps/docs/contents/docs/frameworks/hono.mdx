---
title: "Hono Integration"
description: "Register routes and handle errors with Hono framework."
icon: "bolt"
---

## Installation

```bash
bun add hono
```

Import the Hono integration:

```typescript
import {
  registerHonoRoutes,
  onionErrorHandler,
  mapErrorToHttpException,
} from '@cosmneo/onion-lasagna/backend/frameworks/hono';
```

---

## Quick Start

```typescript
import { Hono } from 'hono';
import { registerHonoRoutes, onionErrorHandler } from '@cosmneo/onion-lasagna/backend/frameworks/hono';

const app = new Hono();

// Apply error handler
app.onError(onionErrorHandler);

// Register routes
registerHonoRoutes(app, routes);

export default app;
```

---

## Registering Routes

The `registerHonoRoutes` function registers your controllers with Hono:

```typescript
import type { RouteInput } from '@cosmneo/onion-lasagna/backend/core/onion-layers';

const routes: RouteInput[] = [
  {
    metadata: {
      method: 'GET',
      path: '/users/{userId}',  // {param} syntax converted to :param
    },
    controller: getUserController,
    requestDtoFactory: GetUserRequestDto.create,
  },
  {
    metadata: {
      method: 'POST',
      path: '/users',
    },
    controller: createUserController,
    requestDtoFactory: CreateUserRequestDto.create,
  },
];

registerHonoRoutes(app, routes);
```

### Path Parameter Conversion

Paths use `{param}` syntax which is automatically converted to Hono's `:param` format:

- `/users/{userId}` → `/users/:userId`
- `/orders/{orderId}/items/{itemId}` → `/orders/:orderId/items/:itemId`

---

## Options

```typescript
interface RegisterRoutesOptions {
  prefix?: string;                // Route prefix (e.g., '/api/v1')
  middlewares?: HonoMiddleware[]; // Middlewares to apply to all routes
}

// With options
registerHonoRoutes(app, routes, {
  prefix: '/api/v1',
  middlewares: [authMiddleware, loggingMiddleware],
});
```

---

## Contextual Routes (Protected Routes)

For routes that need authentication context (user ID, roles, etc.), use `ContextualRouteInput` with a `contextExtractor`:

```typescript
import type {
  ContextualRouteInput,
  ContextualHttpRequest,
} from '@cosmneo/onion-lasagna/backend/frameworks/hono';

// Define your auth context type
interface AuthContext {
  userId: string;
  roles: string[];
}

// Define contextual routes
const protectedRoutes: ContextualRouteInput<AuthContext>[] = [
  {
    metadata: { method: 'GET', path: '/profile' },
    controller: getProfileController,
    requestDtoFactory: (req: ContextualHttpRequest<AuthContext>) =>
      GetProfileRequestDto.create(req),
  },
];

// Register with contextExtractor
registerHonoRoutes(app, protectedRoutes, {
  middlewares: [authMiddleware],
  contextExtractor: (c): AuthContext => ({
    userId: c.get('userId'),
    roles: c.get('roles') ?? [],
  }),
});
```

The `contextExtractor` runs after middlewares, extracting auth data set by your auth middleware:

```typescript
// Auth middleware sets context
const authMiddleware: MiddlewareHandler = async (c, next) => {
  const token = c.req.header('Authorization');
  const payload = verifyToken(token);
  c.set('userId', payload.userId);
  c.set('roles', payload.roles);
  await next();
};
```

### Route Input Types

| Type | Use Case |
|------|----------|
| `HttpRouteInput` | Public routes (no auth context) |
| `ContextualRouteInput<TContext>` | Protected routes with auth context |
| `RouteInputOrArray` | Single or array of public routes |
| `ContextualRouteInputOrArray<TContext>` | Single or array of protected routes |

---

## Error Handler

The `onionErrorHandler` maps domain errors to HTTP responses:

```typescript
app.onError(onionErrorHandler);
```

### Error Mapping

| Error Type | HTTP Status | Body |
|------------|-------------|------|
| `ObjectValidationError` | 400 | `{ errorCode, message, errorItems }` |
| `InvalidRequestError` | 400 | `{ errorCode, message, errorItems }` |
| `AccessDeniedError` | 403 | `{ errorCode, message }` |
| `NotFoundError` | 404 | `{ errorCode, message }` |
| `ConflictError` | 409 | `{ errorCode, message }` |
| `UnprocessableError` | 422 | `{ errorCode, message }` |
| `DomainError` | 500 | Masked |
| `InfraError` | 500 | Masked |
| Unknown | 500 | Masked |

<Callout type="warning">
**Masked errors** return `{ "message": "An unexpected error occurred", "errorCode": "INTERNAL_ERROR" }`. Domain and infrastructure errors are masked to prevent leaking implementation details. See [Error Handling](/docs/patterns/error-handling#translating-domain-errors) for how to expose business errors.
</Callout>

---

## Custom Error Handling

Use `mapErrorToHttpException` for custom error handling:

```typescript
import { mapErrorToHttpException } from '@cosmneo/onion-lasagna/backend/frameworks/hono';

app.onError((error, c) => {
  // Log all errors
  console.error('Error:', error);

  // Use standard mapping
  const httpException = mapErrorToHttpException(error);
  return httpException.getResponse();
});
```

---

## Controller Structure

Controllers receive the raw Hono context and should return an `HttpResponse` wrapped in a DTO:

```typescript
import type { HttpResponse } from '@cosmneo/onion-lasagna/backend/core/onion-layers';

class GetUserController extends BaseController<
  GetUserRequestDto,
  HttpResponseDto<GetUserResponse>,
  GetUserInputDto,
  GetUserOutputDto
> {
  static create(useCase: GetUserQueryInboundPort) {
    return new GetUserController({
      requestMapper: (dto) => GetUserInputDto.fromRequest(dto),
      useCase,
      responseMapper: (output) => HttpResponseDto.ok(output.data),
    });
  }
}
```

---

## Complete Example

```typescript
import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { registerHonoRoutes, onionErrorHandler } from '@cosmneo/onion-lasagna/backend/frameworks/hono';

// Create app
const app = new Hono();

// Middleware
app.use('*', cors());

// Error handling
app.onError(onionErrorHandler);

// Health check
app.get('/health', (c) => c.json({ status: 'ok' }));

// API routes
registerHonoRoutes(app, userRoutes, { prefix: '/api/v1' });
registerHonoRoutes(app, orderRoutes, { prefix: '/api/v1' });

export default app;
```

---

## Cloudflare Workers

```typescript
// src/index.ts
import { Hono } from 'hono';
import { registerHonoRoutes, onionErrorHandler } from '@cosmneo/onion-lasagna/backend/frameworks/hono';

const app = new Hono();

app.onError(onionErrorHandler);
registerHonoRoutes(app, routes);

export default app;
```

```toml
# wrangler.toml
name = "my-worker"
main = "src/index.ts"
compatibility_date = "2024-01-01"
```
