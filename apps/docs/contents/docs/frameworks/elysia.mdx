---
title: "Elysia Integration"
description: "Register routes and handle errors with Elysia framework."
icon: "rabbit"
---

## Installation

```bash
bun add elysia
```

Import the Elysia integration:

```typescript
import {
  registerElysiaRoutes,
  onionErrorHandler,
  mapErrorToResponse,
} from '@cosmneo/onion-lasagna/backend/frameworks/elysia';
```

---

## Quick Start

```typescript
import { Elysia } from 'elysia';
import { registerElysiaRoutes, onionErrorHandler } from '@cosmneo/onion-lasagna/backend/frameworks/elysia';

const app = new Elysia()
  .error(onionErrorHandler)
  .use(registerElysiaRoutes(routes));

app.listen(3000);
```

---

## Registering Routes

The `registerElysiaRoutes` function returns an Elysia plugin:

```typescript
import type { RouteInput } from '@cosmneo/onion-lasagna/backend/core/onion-layers';

const routes: RouteInput[] = [
  {
    metadata: {
      method: 'GET',
      path: '/users/{userId}',
    },
    controller: getUserController,
    requestDtoFactory: GetUserRequestDto.create,
  },
];

const app = new Elysia()
  .use(registerElysiaRoutes(routes));
```

### Path Parameter Conversion

Paths use `{param}` syntax which is automatically converted to Elysia's `:param` format.

---

## Options

```typescript
interface RegisterRoutesOptions {
  prefix?: string;
  middlewares?: ElysiaMiddleware[];
}

const app = new Elysia()
  .use(registerElysiaRoutes(routes, {
    prefix: '/api/v1',
    middlewares: [authMiddleware],
  }));
```

---

## Contextual Routes (Protected Routes)

For routes that need authentication context, use `ContextualRouteInput` with a `contextExtractor`:

```typescript
import type {
  ContextualRouteInput,
  ContextualHttpRequest,
} from '@cosmneo/onion-lasagna/backend/frameworks/elysia';

interface AuthContext {
  userId: string;
  roles: string[];
}

const protectedRoutes: ContextualRouteInput<AuthContext>[] = [
  {
    metadata: { method: 'GET', path: '/profile' },
    controller: getProfileController,
    requestDtoFactory: (req: ContextualHttpRequest<AuthContext>) =>
      GetProfileRequestDto.create(req),
  },
];

const app = new Elysia()
  .use(registerElysiaRoutes(protectedRoutes, {
    middlewares: [authMiddleware],
    contextExtractor: (ctx): AuthContext => ({
      userId: ctx.store.userId,
      roles: ctx.store.roles ?? [],
    }),
  }));
```

### Route Input Types

| Type | Use Case |
|------|----------|
| `HttpRouteInput` | Public routes (no auth context) |
| `ContextualRouteInput<TContext>` | Protected routes with auth context |
| `RouteInputOrArray` | Single or array of public routes |
| `ContextualRouteInputOrArray<TContext>` | Single or array of protected routes |

---

## Error Handler

The `onionErrorHandler` is a function that handles errors:

```typescript
const app = new Elysia()
  .error(onionErrorHandler);
```

### Error Mapping

| Error Type | HTTP Status | Body |
|------------|-------------|------|
| `ObjectValidationError` | 400 | `{ errorCode, message, errorItems }` |
| `InvalidRequestError` | 400 | `{ errorCode, message, errorItems }` |
| `AccessDeniedError` | 403 | `{ errorCode, message }` |
| `NotFoundError` | 404 | `{ errorCode, message }` |
| `ConflictError` | 409 | `{ errorCode, message }` |
| `UnprocessableError` | 422 | `{ errorCode, message }` |
| `DomainError` | 500 | Masked |
| `InfraError` | 500 | Masked |
| Unknown | 500 | Masked |

<Callout type="warning">
**Masked errors** return `{ "message": "An unexpected error occurred", "errorCode": "INTERNAL_ERROR" }`. Domain and infrastructure errors are masked to prevent leaking implementation details. See [Error Handling](/docs/patterns/error-handling#translating-domain-errors) for how to expose business errors.
</Callout>

---

## Custom Error Handling

Use `mapErrorToResponse` for custom handling:

```typescript
import { mapErrorToResponse } from '@cosmneo/onion-lasagna/backend/frameworks/elysia';

const app = new Elysia()
  .error(({ error }) => {
    console.error('Error:', error);

    const { statusCode, body } = mapErrorToResponse(error);
    return new Response(JSON.stringify(body), {
      status: statusCode,
      headers: { 'Content-Type': 'application/json' },
    });
  });
```

---

## Complete Example

```typescript
import { Elysia } from 'elysia';
import { cors } from '@elysiajs/cors';
import { registerElysiaRoutes, onionErrorHandler } from '@cosmneo/onion-lasagna/backend/frameworks/elysia';

const app = new Elysia()
  .use(cors())
  .error(onionErrorHandler)
  .get('/health', () => ({ status: 'ok' }))
  .use(registerElysiaRoutes(userRoutes, { prefix: '/api/v1' }))
  .use(registerElysiaRoutes(orderRoutes, { prefix: '/api/v1' }));

app.listen(3000);

console.log(`Server running at http://localhost:3000`);
```
