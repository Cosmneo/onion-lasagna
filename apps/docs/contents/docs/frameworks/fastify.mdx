---
title: "Fastify Integration"
description: "Register routes and handle errors with Fastify framework."
icon: "rocket"
---

## Installation

```bash
bun add fastify
```

Import the Fastify integration:

```typescript
import {
  registerFastifyRoutes,
  onionErrorHandler,
  mapErrorToResponse,
} from '@cosmneo/onion-lasagna/backend/frameworks/fastify';
```

---

## Quick Start

```typescript
import Fastify from 'fastify';
import { registerFastifyRoutes, onionErrorHandler } from '@cosmneo/onion-lasagna/backend/frameworks/fastify';

const app = Fastify();

// Apply error handler
app.setErrorHandler(onionErrorHandler);

// Register routes
registerFastifyRoutes(app, routes);

app.listen({ port: 3000 });
```

---

## Registering Routes

The `registerFastifyRoutes` function registers your controllers with Fastify:

```typescript
import type { RouteInput } from '@cosmneo/onion-lasagna/backend/core/onion-layers';

const routes: RouteInput[] = [
  {
    metadata: {
      method: 'GET',
      path: '/users/{userId}',
    },
    controller: getUserController,
    requestDtoFactory: GetUserRequestDto.create,
  },
];

registerFastifyRoutes(app, routes);
```

### Path Parameter Conversion

Paths use `{param}` syntax which is automatically converted to Fastify's `:param` format.

---

## Options

```typescript
interface RegisterRoutesOptions {
  prefix?: string;
  middlewares?: FastifyMiddleware[];
}

registerFastifyRoutes(app, routes, {
  prefix: '/api/v1',
  middlewares: [authMiddleware],
});
```

---

## Contextual Routes (Protected Routes)

For routes that need authentication context, use `ContextualRouteInput` with a `contextExtractor`:

```typescript
import type {
  ContextualRouteInput,
  ContextualHttpRequest,
} from '@cosmneo/onion-lasagna/backend/frameworks/fastify';

interface AuthContext {
  userId: string;
  roles: string[];
}

const protectedRoutes: ContextualRouteInput<AuthContext>[] = [
  {
    metadata: { method: 'GET', path: '/profile' },
    controller: getProfileController,
    requestDtoFactory: (req: ContextualHttpRequest<AuthContext>) =>
      GetProfileRequestDto.create(req),
  },
];

registerFastifyRoutes(app, protectedRoutes, {
  middlewares: [authMiddleware],
  contextExtractor: (request): AuthContext => ({
    userId: request.user.id,
    roles: request.user.roles ?? [],
  }),
});
```

### Route Input Types

| Type | Use Case |
|------|----------|
| `HttpRouteInput` | Public routes (no auth context) |
| `ContextualRouteInput<TContext>` | Protected routes with auth context |
| `RouteInputOrArray` | Single or array of public routes |
| `ContextualRouteInputOrArray<TContext>` | Single or array of protected routes |

---

## Error Handler

The `onionErrorHandler` maps domain errors to HTTP responses:

```typescript
app.setErrorHandler(onionErrorHandler);
```

### Error Mapping

| Error Type | HTTP Status | Body |
|------------|-------------|------|
| `ObjectValidationError` | 400 | `{ errorCode, message, errorItems }` |
| `InvalidRequestError` | 400 | `{ errorCode, message, errorItems }` |
| `AccessDeniedError` | 403 | `{ errorCode, message }` |
| `NotFoundError` | 404 | `{ errorCode, message }` |
| `ConflictError` | 409 | `{ errorCode, message }` |
| `UnprocessableError` | 422 | `{ errorCode, message }` |
| `DomainError` | 500 | Masked |
| `InfraError` | 500 | Masked |
| Unknown | 500 | Masked |

<Callout type="warning">
**Masked errors** return `{ "message": "An unexpected error occurred", "errorCode": "INTERNAL_ERROR" }`. Domain and infrastructure errors are masked to prevent leaking implementation details. See [Error Handling](/docs/patterns/error-handling#translating-domain-errors) for how to expose business errors.
</Callout>

---

## Custom Error Handling

Use `mapErrorToResponse` for custom handling:

```typescript
import { mapErrorToResponse } from '@cosmneo/onion-lasagna/backend/frameworks/fastify';

app.setErrorHandler((error, request, reply) => {
  console.error('Error:', error);

  const { statusCode, body } = mapErrorToResponse(error);
  reply.status(statusCode).send(body);
});
```

---

## Complete Example

```typescript
import Fastify from 'fastify';
import cors from '@fastify/cors';
import { registerFastifyRoutes, onionErrorHandler } from '@cosmneo/onion-lasagna/backend/frameworks/fastify';

const app = Fastify({ logger: true });

// Plugins
await app.register(cors);

// Error handling
app.setErrorHandler(onionErrorHandler);

// Health check
app.get('/health', () => ({ status: 'ok' }));

// API routes
registerFastifyRoutes(app, userRoutes, { prefix: '/api/v1' });
registerFastifyRoutes(app, orderRoutes, { prefix: '/api/v1' });

// Start
try {
  await app.listen({ port: 3000 });
  console.log('Server running at http://localhost:3000');
} catch (err) {
  app.log.error(err);
  process.exit(1);
}
```

---

## Type Providers

Fastify's type system works with the integration:

```typescript
import Fastify from 'fastify';
import type { TypeBoxTypeProvider } from '@fastify/type-provider-typebox';

const app = Fastify().withTypeProvider<TypeBoxTypeProvider>();
```
