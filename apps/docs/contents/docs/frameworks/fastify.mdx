---
title: "Fastify Integration"
description: "Register routes and handle errors with Fastify framework."
icon: "rocket"
---

## Installation

```bash
bun add fastify
```

Import the Fastify integration:

```typescript
import {
  registerFastifyRoutes,
  onionErrorHandler,
  mapErrorToResponse,
} from '@cosmneo/onion-lasagna/backend/frameworks/fastify';
```

---

## Quick Start

```typescript
import Fastify from 'fastify';
import { registerFastifyRoutes, onionErrorHandler } from '@cosmneo/onion-lasagna/backend/frameworks/fastify';

const app = Fastify();

// Apply error handler
app.setErrorHandler(onionErrorHandler);

// Register routes
registerFastifyRoutes(app, routes);

app.listen({ port: 3000 });
```

---

## Registering Routes

The `registerFastifyRoutes` function registers your controllers with Fastify:

```typescript
import type { RouteInput } from '@cosmneo/onion-lasagna/backend/core/onion-layers';

const routes: RouteInput[] = [
  {
    metadata: {
      method: 'GET',
      path: '/users/{userId}',
    },
    controller: getUserController,
    requestDtoFactory: GetUserRequestDto.create,
  },
];

registerFastifyRoutes(app, routes);
```

### Path Parameter Conversion

Paths use `{param}` syntax which is automatically converted to Fastify's `:param` format.

---

## Options

```typescript
interface RegisterRoutesOptions {
  prefix?: string;
  middlewares?: FastifyMiddleware[];
}

registerFastifyRoutes(app, routes, {
  prefix: '/api/v1',
  middlewares: [authMiddleware],
});
```

---

## Error Handler

The `onionErrorHandler` maps domain errors to HTTP responses:

```typescript
app.setErrorHandler(onionErrorHandler);
```

### Error Mapping

| Error Type | HTTP Status | Body |
|------------|-------------|------|
| `ObjectValidationError` | 400 | `{ code, message, errors }` |
| `InvalidRequestError` | 400 | `{ code, message, errors }` |
| `AccessDeniedError` | 403 | `{ code, message }` |
| `NotFoundError` | 404 | `{ code, message }` |
| `ConflictError` | 409 | `{ code, message }` |
| `UnprocessableError` | 422 | `{ code, message }` |
| Internal errors | 500 | `{ message: 'Internal Server Error' }` |

---

## Custom Error Handling

Use `mapErrorToResponse` for custom handling:

```typescript
import { mapErrorToResponse } from '@cosmneo/onion-lasagna/backend/frameworks/fastify';

app.setErrorHandler((error, request, reply) => {
  console.error('Error:', error);

  const { statusCode, body } = mapErrorToResponse(error);
  reply.status(statusCode).send(body);
});
```

---

## Complete Example

```typescript
import Fastify from 'fastify';
import cors from '@fastify/cors';
import { registerFastifyRoutes, onionErrorHandler } from '@cosmneo/onion-lasagna/backend/frameworks/fastify';

const app = Fastify({ logger: true });

// Plugins
await app.register(cors);

// Error handling
app.setErrorHandler(onionErrorHandler);

// Health check
app.get('/health', () => ({ status: 'ok' }));

// API routes
registerFastifyRoutes(app, userRoutes, { prefix: '/api/v1' });
registerFastifyRoutes(app, orderRoutes, { prefix: '/api/v1' });

// Start
try {
  await app.listen({ port: 3000 });
  console.log('Server running at http://localhost:3000');
} catch (err) {
  app.log.error(err);
  process.exit(1);
}
```

---

## Type Providers

Fastify's type system works with the integration:

```typescript
import Fastify from 'fastify';
import type { TypeBoxTypeProvider } from '@fastify/type-provider-typebox';

const app = Fastify().withTypeProvider<TypeBoxTypeProvider>();
```
